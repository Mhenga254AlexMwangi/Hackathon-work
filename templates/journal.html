{% extends "base.html" %}
{% block title %}Emotional Journal · MoodTracker{% endblock %}
{% block content %}
<div class="card">
    <h2><i class="fas fa-book-open"></i> Emotional Journal Entry</h2>
    <p>Write about your day, your feelings, or anything on your mind. Our AI will analyze your emotions and provide insights.</p>
    
    <form class="form" id="journalForm">
        <label for="journalEntry">How are you feeling today?</label>
        <textarea id="journalEntry" name="journalEntry" placeholder="Express your thoughts and feelings here..." required></textarea>
        
        <button class="btn" type="submit"><i class="fas fa-cloud-upload-alt"></i> Analyze & Save</button>
    </form>
    
    <div class="loading" id="loadingIndicator">
        <div class="loading-spinner"></div>
        <p>Analyzing your emotions...</p>
    </div>
    
    <div class="api-warning" id="apiWarning" style="display: none; background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin: 20px 0;">
        <i class="fas fa-exclamation-triangle"></i> 
        <strong>Note:</strong> Using demo emotion data. To enable real emotion analysis, please configure the Hugging Face API token.
    </div>
    
    <div class="results-container" id="resultsContainer">
        <h3><i class="fas fa-chart-pie"></i> Emotional Analysis Results</h3>
        <p>Based on your journal entry, here's your emotional breakdown:</p>
        
        <div class="emotion-results" id="emotionResults">
            <!-- Results will be inserted here by JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('journalForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const journalText = document.getElementById('journalEntry').value.trim();
        if (!journalText) {
            alert('Please write something in your journal entry');
            return;
        }
        
        // Show loading indicator
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('resultsContainer').style.display = 'none';
        document.getElementById('apiWarning').style.display = 'none';
        
        try {
            // Send journal entry to Flask API
            const response = await fetch('{{ url_for("analyze_emotions") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: journalText })  // ✅ fixed key
            });
            
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                displayEmotionResults(result.results);
                alert("Journal entry analyzed and saved successfully!");
            } else {
                throw new Error(result.message);
            }
            
            // Show API warning if mock data was returned
            const hasRoundNumbers = result.results.some(emotion => {
                const score = emotion.score;
                return [0.75, 0.15, 0.05, 0.03, 0.01].includes(score);
            });
            
            if (hasRoundNumbers) {
                document.getElementById('apiWarning').style.display = 'block';
            }
            
        } catch (error) {
            console.error('Error:', error);
            alert("Error analyzing entry. Showing fallback data.");
            
            // Fallback mock data
            const mockData = [
                {label: "joy", score: 0.65},
                {label: "sadness", score: 0.20},
                {label: "anger", score: 0.07},
                {label: "fear", score: 0.05},
                {label: "surprise", score: 0.02},
                {label: "disgust", score: 0.01}
            ];
            displayEmotionResults(mockData);
            document.getElementById('apiWarning').style.display = 'block';
        } finally {
            document.getElementById('loadingIndicator').style.display = 'none';
        }
    });
    
    function displayEmotionResults(emotionData) {
        const resultsContainer = document.getElementById('emotionResults');
        resultsContainer.innerHTML = '';
        
        // Find primary emotion
        let primaryEmotion = null;
        let maxScore = 0;
        
        emotionData.forEach(emotion => {
            if (emotion.score > maxScore) {
                maxScore = emotion.score;
                primaryEmotion = emotion.label;
            }
        });
        
        // Create emotion items
        emotionData.forEach(emotion => {
            const emotionItem = document.createElement('div');
            emotionItem.className = 'emotion-item';
            if (emotion.label === primaryEmotion) {
                emotionItem.classList.add('primary-emotion');
            }
            
            const scorePercent = Math.round(emotion.score * 100);
            emotionItem.innerHTML = `
                <div class="emotion-name">${emotion.label}</div>
                <div class="emotion-score">${scorePercent}%</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${scorePercent}%"></div>
                </div>
            `;
            resultsContainer.appendChild(emotionItem);
        });
        
        // Show results
        document.getElementById('resultsContainer').style.display = 'block';
        document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth' });
    }
</script>
{% endblock %}
